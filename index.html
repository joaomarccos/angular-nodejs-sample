<html ng-app="app">
<head>
	<meta charset="UTF-8">
	<title>Angular School</title>
	<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
	<style>
		input, button, select{
			margin: 2px;
		}
	</style>
</head>
<body ng-controller="controller" style="margin: 0 auto; width: 500px">
	<div class="well well-sm text-center">
		<h2>Lista Telefonica</h2>
	</div>
	<div class="panel">
		<div class="panel-header"><h3>Contatos:</h3></div>
		<div class="panel-body">
		<div class="input-group">					
			<input type="text" class="form-control" ng-model="busca" placeholder="busca" style="margin: 0">			
			<div class="input-group-addon"><i class="glyphicon glyphicon-search"></i></div>			
		</div>
		<br>
			<table class="table table-responsive" ng-show="contatos.length">
				<tr>
					<th></th>
					<th>Nome</th>
					<th>Telefone</th>
					<th>Operadora</th>
					<th></th>
				</tr>
				<tr ng-click="contato.selecionado = !contato.selecionado" ng-repeat="contato in contatos | filter:busca | orderBy:'name'" ng-class="{'bg-warning': contato.selecionado}">
					<td>
						<input ng-model="contato.selecionado" type="checkbox">
					</td>
					<td>
						{{contato.name}}
					</td>
					<td>
						{{contato.phone}}
					</td>
					<td>
						{{contato.operadora.name | uppercase}}
					</td>
					<td>
						<div style="width: 20px; height:20px; border-radius: 50%" ng-style="{'background-color': contato.color}"></div>
					</td>
				</tr>
			</table>
		</div>			
		<div class="panel-footer">
			<form name="contatoForm">
				<h4>Adicione um contato:</h4>
				<input placeholder="Nome" type="text" class="form-control" ng-model="contato.name" ng-required="true" ng-minlength="10" name="name">
				<input placeholder="telefone" type="text" class="form-control" ng-model="contato.phone"ng-required="true" name="phone" ng-pattern="/^\d{4,5}-\d{4}$/">						
				<select name="operadoras" class="form-control" ng-model="contato.operadora" ng-options="operadora.name group by operadora.categoria for operadora in operadoras">
					<option value="">Selecione uma Operadora</option>
				</select>
				<br>
				<div class="form-group">  				
					<label>Atribua uma cor:</label>						
					<input class="form-control" type="color" ng-model="contato.color" value="#000000">				
				</div>
			</form>
			<br>					
			<button class="btn btn-block btn-primary" ng-click="adicionarContato(contato)" ng-disabled="contatoForm.$invalid">Adicionar contato</button>			
			<button class="btn btn-block btn-danger" ng-hide="!isContatoSelecionado(contatos)" ng-click="apagarContatos(
			contatos)" >Apagar contatos selecionados</button>										
			<br>
			<div ng-messages="contatoForm.name.$error" ng-if="contatoForm.name.$dirty">
				<div ng-message="required" class="alert alert-danger">
					Nome é obrigatório
				</div>
				<div ng-message="minlength" class="alert alert-danger">
					Nome muito curto
				</div>				
			</div>			
			<div ng-messages="contatoForm.phone.$error" ng-if="contatoForm.phone.$dirty">
				<div ng-message="required" class="alert alert-danger">
					Telefone é obrigatório
				</div>
				<div ng-message="pattern" class="alert alert-danger">
					Telefone deve estar no padrão 00000-0000
				</div>				
			</div>
		</div>
	</div>
	<div ng-include="'footer.html'" scope="" onload=""></div>
</body>

<script type="text/javascript" src="bower_components/angular/angular.js"></script>
<script type="text/javascript" src="bower_components/angular-messages/angular-messages.js"></script>
<script type="text/javascript">
	/**
	* app Module
	*
	* Modulo principal da aplicação
	*/
	angular.module('app', ['ngMessages']);
	angular.module('app').controller('controller', function($scope, $http){
		$scope.contatos = [];
		$scope.operadoras = [];

		var carregarContatos = function  () {
			$http.get("http://127.0.0.1:3000/contatos").then(function (response) {
				$scope.contatos = response.data;				
			});
		};

		var carregarOperadoras = function  () {
			$http.get("http://127.0.0.1:3000/operadoras").then(function (response) {
				$scope.operadoras = response.data;				
			});
		};

		$scope.adicionarContato = function (contato) {
			$scope.contatos.push(angular.copy(contato));
			delete $scope.contato;
			$scope.contatoForm.$setPristine();
		};

		$scope.apagarContatos = function  (contatos) {
			$scope.contatos = (contatos.filter(function  (contato) {
				return !contato.selecionado;
			}))
		};		

		$scope.isContatoSelecionado = function  (contatos) {
			 return contatos.some(function  (contato) {
				return contato.selecionado;
			})
		};

		carregarContatos();
		carregarOperadoras();
	});

</script>
</html>